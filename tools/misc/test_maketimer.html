<!DOCTYPE html>
<HTML>
<!-- This is a test page for an easy-start visual timer of any length. The resulting code can be integrated with any web page. -->

<HEAD>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="icon" href="/favicon-32x32.png">
<link rel="stylesheet" href="/fz.css">
<style>
.timerpanel {
    float: right;
    width: 10.0%;
    padding: 10px;
}
.timerBar {
  width: 100px;
  height: 400px; /* in CSS 96px == 1 inch */
  background-color: rgb(50, 82, 20);
  position: relative;
  text-align: center;
  display: flex;
  justify-content: center;
}
.timerBarFill {
  background-color: rgb(107, 206, 15);
  width: 100%;
  height: 100%;
  position: absolute;
  bottom: 0;
  transition: 1s;
}
.timerBarText {
  position: relative;
  top: 10px;
  width: 100%;
  text-align: center;
  color: #ffffff;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.5em;
}
</style>
<TITLE>Test: Timer</TITLE>
</HEAD>
<BODY>

<H1>Test: Timer</H1>

<p>
<button id="startTimer" class="button button1" onclick="button_timer_start();">Start</button>   
</p>
<p>
<button id="startTimer" class="button button2" onclick="timer_end();">Stop</button>
</p>
<p>
Hours: <input id="timerHours" type="number" min="0" max="100" value="0">
</p>
<p>
Minutes: <input id="timerMinutes" type="number" min="0" max="10000" value="5">
</p>

<div class="timepanel">
<section class="container">
    <div class="timerBar">
        <div class="timerBarFill">
        </div>
        <div class="timerBarTextContainer">
            <div class="timerBarText"></div>
        </div>
    </div>
</section>

<script type="text/javascript">

const fill = document.querySelector(".timerBarFill");
const text = document.querySelector(".timerBarText");
let chunk_seconds = 20*60;
// a bit pointless, because CSS pixels are not real pixels, better to just redraw each second
//let secondsperupdate = chunk_seconds / 600; // e.g. 20*60 / 600 = 2 seconds
let secondsperupdate = 1;
let secondsLeft = chunk_seconds;
let heightPct = 0; // start empty before a timer is set
fill.style.height = 0;

// every hundred millisecond, but probably should only do when a line less
//let countDown = setInterval(tick, secondsperupdate * 1000);
let countDown = null;

function tick() {
    secondsLeft -= secondsperupdate;
    var minsleft = Math.floor(secondsLeft / 60);
    var secsleft = secondsLeft % 60;
    var secstr = ("0" + secsleft).substr(-2);
    text.textContent = `${minsleft}:${secstr}`;
    if (secondsLeft === 0) {
        clearInterval(countDown);
        fill.style.height = 0;
        return;
    }
    heightPct = 100 * secondsLeft / chunk_seconds;
    //console.log(`${heightPct}%`);
    fill.style.height = `${heightPct}%`;
    if (heightPct < 50) {
        fill.style.backgroundColor = '#f2ed6d';
    }
    if (heightPct < 25) {
        fill.style.backgroundColor = '#ea7267';
    }

}
function timer_start(mins) {
    console.log('Timer mins = ' + mins);
    chunk_seconds = mins * 60;
    secondsLeft = chunk_seconds;
    heightPct = 100;
    fill.style.height = `100%`;
    countDown = setInterval(tick, secondsperupdate * 1000);
}
function timer_end() {
    clearInterval(countDown);
    secondsLeft = 0;
}
function button_timer_start() {
    const hours_input = document.getElementById("timerHours");
    const minutes_input = document.getElementById("timerMinutes");
    var mins = minutes_input.value;
    var hours = hours_input.value;
    timer_start(mins+(60*hours));
}

window.onload = function() {

    source.addEventListener("TC_start", function(event) {
        const t = JSON.parse(event.data).t;
        const mins = JSON.parse(event.data).mins;
        console.log('Event t_start = '+t);
        timer_start(mins);
    });

    source.addEventListener("TC_end", function(event) {
        const t = JSON.parse(event.data).t
        console.log('Event t_end = '+ t)
        timer_end();
    });

};

</script>
</BODY>

</HTML>
