<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Test FZ CGI Request</title>
<style>
/* Define the flashing sequence */
@keyframes warning-flash {
  0% { background-color: #ff0000; color: white; }    /* Bright Red */
  50% { background-color: #8b0000; color: #cccccc; } /* Dark Red */
  100% { background-color: #ff0000; color: white; }   /* Back to Bright */
}

/* The class that triggers the flash */
.flashing {
  animation: warning-flash 0.8s infinite; /* Cycles every 0.8 seconds forever */
  border: 2px solid white;
  box-shadow: 0 0 10px rgba(255, 0, 0, 0.8); /* Optional glow effect */
}

/* Basic button styling */
#my-button {
  padding: 10px 20px;
  background-color: #ccc;
  cursor: pointer;
  transition: all 0.3s;
}
</style>
</head>
<body>

<h1>Test FZ CGI Request</h1>

<div id="some_id" data-response="{}">
Click Here
</div>

<p>
	<button id='button_id'>Week Goals</button>
</p>

<script>
</script>

<script type="module">
import { fzCGIRequest, setupfzCGIListener, pollfzServer } from '/fzCGIRequest.js';

const btn = document.getElementById('button_id');

// Function to start the warning
function startWarning() {
    btn.classList.add('flashing');
}

// Function to stop the warning
function stopWarning() {
    btn.classList.remove('flashing');
}

function responseHandler(data) {
	const element = document.getElementById('some_id');
    element.dataset.response = data;
    element.innerHTML = `<textarea rows=40 cols=160>${data}</textarea>`;
    //console.log(element.dataset.response);
    let logdata = JSON.parse(data);
    if ('chunks_rendered' in logdata) {
    	console.log(`Number of chunks returned: ${logdata['chunks_rendered']}`);
    	if (logdata['chunks_rendered'] == 1) {
    		console.log(`Last chunk in history of Node at epoch: ${logdata['chunks'][0][0]}`);
    		const unixtime_ms = logdata['chunks'][0][0] * 1000;
    		const now = Date.now();
    		const elapsed_ms = now - unixtime_ms;
    		const elapsed_days = elapsed_ms / (24*60*60*1000);
    		console.log(`Days elapsed: ${elapsed_days}`);
    		if (elapsed_days > 7.0) {
    			startWarning();
    		} else {
    			stopWarning();
    		}
    	}
    }
}

const fzcgiutil = '/cgi-bin/fzloghtml-cgi.py';
const argstuples = [['json','on'], ['node', '20240603105017.1'], ['frommostrecent', 'on'], ['numchunks', '1']];

setupfzCGIListener('some_id', fzcgiutil, argstuples, responseHandler);

pollfzServer(fzcgiutil, argstuples, responseHandler, 5000); // Start the loop

</script>

</body>
</html>
